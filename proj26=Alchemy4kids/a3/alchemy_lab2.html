<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Alchemy Laboratory - Fullmetal Alchemist</title>
    <style>
        
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Philosopher:wght@400;700&family=Crimson+Text:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            font-family: 'Philosopher', serif;
            color: #f5f5dc;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        
        /* Floating particles background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffd700;
            border-radius: 50%;
            animation: float 10s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            z-index: 2;
        }
        
        /* Header with animated title */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .title {
            font-family: 'Cinzel', serif;
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ffb347, #ff6b35, #ffd700);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: gradient-shift 3s ease-in-out infinite;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #b8860b;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #ffd700;
            color: #ffd700;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .nav-btn:hover {
            background: linear-gradient(45deg, #ffd700, #ffb347);
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        
        .nav-btn.active {
            background: linear-gradient(45deg, #ffd700, #ffb347);
            color: #1a1a2e;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
        }
        
        /* Laboratory Interface */
        .lab-interface {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            width: 100%;
            max-width: 1400px;
        }
        
        /* Ingredients Panel */
        .ingredients-panel {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            height: fit-content;
        }
        
        .panel-title {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .ingredient-categories {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .category {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .category-header {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px 15px;
            font-family: 'Cinzel', serif;
            color: #ffd700;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .category.active .category-content {
            max-height: 500px;
            padding: 15px;
        }
        
        .ingredient-item {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            transition: all 0.3s ease;
        }
        
        .ingredient-item:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        .ingredient-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .ingredient-name {
            font-size: 0.9rem;
            text-align: center;
        }
        
        /* Workbench Area */
        .workbench-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .workbench {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .workbench-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 100%;
            height: 500px;
            position: relative;
        }
        
        .grid-cell {
            border: 1px dashed rgba(255, 215, 0, 0.1);
            position: relative;
        }
        
        .placed-ingredient {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: move;
            z-index: 10;
            transition: transform 0.1s ease;
        }
        
        .placed-ingredient:hover {
            transform: scale(1.1);
            z-index: 20;
        }
        
        .placed-icon {
            font-size: 2rem;
            pointer-events: none;
        }
        
        .placed-name {
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 2px;
            pointer-events: none;
        }
        
        .transmutation-circle-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            border: 3px solid rgba(255, 215, 0, 0.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .workbench.show-circle .transmutation-circle-overlay {
            opacity: 0.7;
        }
        
        /* Alchemy Controls */
        .alchemy-controls {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .controls-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            border: 2px solid #ffd700;
            color: #ffd700;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex: 1;
            text-align: center;
        }
        
        .control-btn:hover {
            background: linear-gradient(45deg, #ffd700, #ffb347);
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        
        .control-btn.danger {
            border-color: #ff4500;
            color: #ff4500;
        }
        
        .control-btn.danger:hover {
            background: linear-gradient(45deg, #ff4500, #ff8c00);
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.6);
        }
        
        .control-btn.success {
            border-color: #00bfff;
            color: #00bfff;
        }
        
        .control-btn.success:hover {
            background: linear-gradient(45deg, #00bfff, #0080ff);
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.6);
        }
        
        /* Results Panel */
        .results-panel {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }
        
        .results-content {
            min-height: 200px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px dashed rgba(255, 215, 0, 0.3);
        }
        
        .result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 5px;
        }
        
        .result-icon {
            font-size: 1.5rem;
        }
        
        .result-text {
            flex: 1;
        }
        
        .result-success {
            border-left: 4px solid #00bfff;
        }
        
        .result-failure {
            border-left: 4px solid #ff4500;
        }
        
        .result-warning {
            border-left: 4px solid #ffd700;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            border: 1px solid #ffd700;
            max-width: 200px;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .lab-interface {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 2.5rem;
            }
            
            .category-content {
                grid-template-columns: 1fr;
            }
            
            .controls-row {
                flex-direction: column;
            }
        }
        
        /* Enhanced Workbench Styles */
        .workbench-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .workbench-mode-btn {
            padding: 8px 15px;
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #ffd700;
            color: #ffd700;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .workbench-mode-btn.active {
            background: #ffd700;
            color: #1a1a2e;
        }
        
        /* Circle Controls */
        .circle-controls {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #ffd700;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .circle-control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .circle-control-label {
            min-width: 100px;
            font-size: 0.9rem;
        }
        
        /* Polygon Controls */
        .polygon-controls {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #00bfff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        /* Research Notes Section */
        .research-notes {
            display: none;
            background: rgba(26, 26, 46, 0.9);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }
        
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .note-card {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            height: 300px;
            perspective: 1000px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.3);
        }
        
        .note-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .note-card.flipped .note-card-inner {
            transform: rotateY(180deg);
        }
        
        .note-card-front, .note-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .note-card-front {
            background: rgba(26, 26, 46, 0.8);
            color: #ffd700;
            border-radius: 10px;
        }
        
        .note-card-back {
            background: rgba(26, 26, 46, 0.9);
            color: #ffd700;
            transform: rotateY(180deg);
            border-radius: 10px;
            overflow-y: auto;
        }
        
        .note-title {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            margin-bottom: 10px;
            border-bottom: 1px solid #ffd700;
            padding-bottom: 5px;
        }
        
        .note-date {
            font-size: 0.8rem;
            color: #b8860b;
            margin-bottom: 15px;
        }
        
        .note-circle-preview {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
            position: relative;
        }
        
        .note-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 2px solid #ffd700;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .note-symbol {
            position: absolute;
            color: #ffd700;
            font-weight: bold;
            transform: translate(-50%, -50%);
        }
        
        .note-content {
            flex: 1;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.5;
            overflow-y: auto;
        }
        
        .note-results {
            font-size: 0.85rem;
            text-align: left;
            line-height: 1.4;
        }
        
        /* Save Dialog */
        .save-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            backdrop-filter: blur(10px);
        }
        
        .save-dialog h3 {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .save-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .save-form label {
            display: block;
            margin-bottom: 5px;
            color: #ffd700;
        }
        
        .save-form input, 
        .save-form textarea {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #ffd700;
            border-radius: 5px;
            color: #f5f5dc;
        }
        
        .save-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .save-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* New circle styles */
        .circle-layer {
            position: absolute;
            border-radius: 50%;
            border: 2px solid #ffd700;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .circle-layer.rotating {
            animation: rotate-clockwise 30s linear infinite;
        }
        
        .circle-layer.glowing {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .circle-layer .symbol {
            position: absolute;
            color: #ffd700;
            font-weight: bold;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }
        
        .symbol.glowing {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        /* Polygon styles */
        .polygon-shape {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(-50%, -50%);
            border: 2px solid #00bfff;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }
        
        .polygon-shape .symbol {
            position: absolute;
            color: #00bfff;
            font-weight: bold;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }
        
        /* Animation for new transmutation effects */
        @keyframes transmutation-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .transmutation-effect {
            animation: transmutation-pulse 1s ease-in-out infinite;
        }
        
        /* Additional responsive styles */
        @media (max-width: 768px) {
            .notes-grid {
                grid-template-columns: 1fr;
            }
            
            .workbench-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Floating particles -->
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">Advanced Alchemy Laboratory</h1>
            <p class="subtitle">Experimental Transmutation Workbench & Research Archive</p>
        </div>
        
        <div class="nav">
            <a href="transmutation-circle.html" class="nav-btn">Transmutation Circle</a>
            <a href="#" class="nav-btn active">Alchemy Lab</a>
            <a href="#" class="nav-btn" id="researchNotesBtn">Research Notes</a>
            <a href="#" class="nav-btn">Forbidden Knowledge</a>
        </div>
        
        <!-- Main Lab Interface -->
        <div id="labInterface">
            <div class="lab-interface">
                <!-- Ingredients Panel (same as before) -->
                <div class="ingredients-panel">
                    <h3 class="panel-title">Alchemical Ingredients</h3>
                    <div class="ingredient-categories">
                        <!-- Metals Category -->
                        <div class="category active">
                            <div class="category-header" onclick="toggleCategory(this.parentElement)">
                                <span>Metals</span>
                                <span>▼</span>
                            </div>
                            <div class="category-content">
                                <div class="ingredient-item" draggable="true" data-name="Iron" data-symbol="♂" data-type="metal" data-properties="strength, conductivity">
                                    <div class="ingredient-icon">♂</div>
                                    <div class="ingredient-name">Iron</div>
                                </div>
                                <div class="ingredient-item" draggable="true" data-name="Gold" data-symbol="☉" data-type="metal" data-properties="purity, nobility">
                                    <div class="ingredient-icon">☉</div>
                                    <div class="ingredient-name">Gold</div>
                                </div>
                                <div class="ingredient-item" draggable="true" data-name="Silver" data-symbol="☽" data-type="metal" data-properties="reflection, intuition">
                                    <div class="ingredient-icon">☽</div>
                                    <div class="ingredient-name">Silver</div>
                                </div>
                                <div class="ingredient-item" draggable="true" data-name="Copper" data-symbol="♀" data-type="metal" data-properties="conductivity, beauty">
                                    <div class="ingredient-icon">♀</div>
                                    <div class="ingredient-name">Copper</div>
                                </div>
                                <div class="ingredient-item" draggable="true" data-name="Lead" data-symbol="♄" data-type="metal" data-properties="density, protection">
                                    <div class="ingredient-icon">♄</div>
                                    <div class="ingredient-name">Lead</div>
                                </div>
                                <div class="ingredient-item" draggable="true" data-name="Mercury" data-symbol="☿" data-type="metal" data-properties="fluidity, transformation">
                                    <div class="ingredient-icon">☿</div>
                                    <div class="ingredient-name">Mercury</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Other categories (Minerals, Herbs, Essences) remain the same -->
                          <!-- Minerals Category -->
                    <div class="category">
                        <div class="category-header" onclick="toggleCategory(this.parentElement)">
                            <span>Minerals</span>
                            <span>▼</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-item" draggable="true" data-name="Salt" data-symbol="🜔" data-type="mineral" data-properties="preservation, purification">
                                <div class="ingredient-icon">🜔</div>
                                <div class="ingredient-name">Salt</div>
                            </div>
                            <div class="ingredient-item" draggable="true" data-name="Quartz" data-symbol="◇" data-type="mineral" data-properties="amplification, clarity">
                                <div class="ingredient-icon">◇</div>
                                <div class="ingredient-name">Quartz</div>
                            </div>
                            <div class="ingredient-item" draggable="true" data-name="Sulfur" data-symbol="🜍" data-type="mineral" data-properties="combustion, energy">
                                <div class="ingredient-icon">🜍</div>
                                <div class="ingredient-name">Sulfur</div>
                            </div>
                            <div class="ingredient-item" draggable="true" data-name="Cinnabar" data-symbol="🜓" data-type="mineral" data-properties="transformation, potency">
                                <div class="ingredient-icon">🜓</div>
                                <div class="ingredient-name">Cinnabar</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Herbs Category -->
                    <div class="category">
                        <div class="category-header" onclick="toggleCategory(this.parentElement)">
                            <span>Herbs</span>
                            <span>▼</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-item" draggable="true" data-name="Mandrake" data-symbol="🌿" data-type="herb" data-properties="vitality, animation">
                                <div class="ingredient-icon">🌿</div>
                                <div class="ingredient-name">Mandrake</div>
                            </div>
                            <div class="ingredient-item" draggable="true" data-name="Belladonna" data-symbol="🍃" data-type="herb" data-properties="visions, toxicity">
                                <div class="ingredient-icon">🍃</div>
                                <div class="ingredient-name">Belladonna</div>
                            </div>
                            <div class="ingredient-item" draggable="true" data-name="Wolfsbane" data-symbol="☘️" data-type="herb" data-properties="protection, lycanthropy">
                                <div class="ingredient-icon">☘️</div>
                                <div class="ingredient-name">Wolfsbane</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Essences Category -->
                    <div class="category">
                        <div class="category-header" onclick="toggleCategory(this.parentElement)">
                            <span>Essences</span>
                            <span>▼</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-item" draggable="true" data-name="Aqua Fortis" data-symbol="🜊" data-type="essence" data-properties="dissolution, purification">
                                <div class="ingredient-icon">🜊</div>
                                <div class="ingredient-name">Aqua Fortis</div>
                            </div>
                            <div class="ingredient-item" draggable="true" data-name="Aqua Regia" data-symbol="🜋" data-type="essence" data-properties="royalty, dissolution">
                                <div class="ingredient-icon">🜋</div>
                                <div class="ingredient-name">Aqua Regia</div>
                            </div>
                            <div class="ingredient-item" draggable="true" data-name="Philosopher's Water" data-symbol="🜄" data-type="essence" data-properties="prima materia, potential">
                                <div class="ingredient-icon">🜄</div>
                                <div class="ingredient-name">Philosopher's Water</div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                
                <!-- Enhanced Workbench Area -->
                <div class="workbench-area">
                    <div class="workbench-controls">
                        <button class="workbench-mode-btn active" data-mode="ingredients">Ingredients Mode</button>
                        <button class="workbench-mode-btn" data-mode="circle">Circle Design Mode</button>
                        <button class="workbench-mode-btn" data-mode="polygon">Polygon Design Mode</button>
                    </div>
                    
                    <!-- Circle Controls (visible in Circle Design Mode) -->
                    <div class="circle-controls" id="circleControls" style="display: none;">
                        <div class="circle-control-row">
                            <span class="circle-control-label">Circle Size:</span>
                            <input type="range" min="50" max="300" value="150" id="circleSizeSlider">
                            <span id="circleSizeValue">150px</span>
                        </div>
                        <div class="circle-control-row">
                            <span class="circle-control-label">Symbol Count:</span>
                            <input type="number" min="3" max="12" value="6" id="symbolCountInput">
                            <button onclick="generateCircle()">Generate</button>
                        </div>
                        <div class="circle-control-row">
                            <span class="circle-control-label">Rotation:</span>
                            <button onclick="toggleCircleRotation()" id="rotationToggle">Enable Rotation</button>
                            <span class="circle-control-label">Glow:</span>
                            <button onclick="toggleCircleGlow()" id="glowToggle">Enable Glow</button>
                        </div>
                        <div class="circle-control-row">
                            <button onclick="addNewCircle()">Add New Circle</button>
                            <button onclick="removeSelectedCircle()">Remove Circle</button>
                        </div>
                        <div class="circle-control-row">
                            <button onclick="saveCircleDesign()" class="success">Save Design</button>
                        </div>
                    </div>
                    
                    <!-- Polygon Controls (visible in Polygon Design Mode) -->
                    <div class="polygon-controls" id="polygonControls" style="display: none;">
                        <div class="circle-control-row">
                            <span class="circle-control-label">Shape:</span>
                            <select id="polygonShapeSelect">
                                <option value="3">Triangle</option>
                                <option value="4">Square</option>
                                <option value="5">Pentagon</option>
                                <option value="6">Hexagon</option>
                                <option value="8">Octagon</option>
                            </select>
                            <span class="circle-control-label">Size:</span>
                            <input type="range" min="50" max="300" value="150" id="polygonSizeSlider">
                            <span id="polygonSizeValue">150px</span>
                        </div>
                        <div class="circle-control-row">
                            <span class="circle-control-label">Symbol Count:</span>
                            <input type="number" min="3" max="12" value="6" id="polygonSymbolCountInput">
                            <button onclick="generatePolygon()">Generate</button>
                        </div>
                        <div class="circle-control-row">
                            <span class="circle-control-label">Rotation:</span>
                            <button onclick="togglePolygonRotation()" id="polygonRotationToggle">Enable Rotation</button>
                            <span class="circle-control-label">Glow:</span>
                            <button onclick="togglePolygonGlow()" id="polygonGlowToggle">Enable Glow</button>
                        </div>
                        <div class="circle-control-row">
                            <button onclick="addNewPolygon()">Add New Polygon</button>
                            <button onclick="removeSelectedPolygon()">Remove Polygon</button>
                        </div>
                        <div class="circle-control-row">
                            <button onclick="savePolygonDesign()" class="success">Save Design</button>
                        </div>
                    </div>
                    
                    <div class="workbench" id="workbench">
                        <div class="workbench-grid" id="workbenchGrid"></div>
                    </div>
                    
                    <div class="alchemy-controls">
                        <div class="controls-row">
                            <button class="control-btn" onclick="showTransmutationCircle()">Show Circle</button>
                            <button class="control-btn" onclick="hideTransmutationCircle()">Hide Circle</button>
                            <button class="control-btn danger" onclick="clearWorkbench()">Clear Workbench</button>
                        </div>
                        <div class="controls-row">
                            <button class="control-btn success" onclick="attemptTransmutation()">Attempt Transmutation</button>
                        </div>
                    </div>
                    
                    <div class="results-panel">
                        <h3 class="panel-title">Transmutation Results</h3>
                        <div class="results-content" id="resultsContent">
                            <div class="result-item result-warning">
                                <div class="result-icon">⚗️</div>
                                <div class="result-text">Welcome to the Alchemy Laboratory. Place ingredients on the workbench or design transmutation circles.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Research Notes Section -->
        <div class="research-notes" id="researchNotes">
            <h3 class="panel-title">Research Notes & Saved Designs</h3>
            <div class="notes-grid" id="notesGrid">
                <!-- Notes will be added here dynamically -->
            </div>
        </div>
        
        <!-- Save Design Dialog -->
        <div class="save-dialog" id="saveDialog">
            <h3>Save Alchemical Design</h3>
            <div class="save-form">
                <div>
                    <label for="designName">Design Name:</label>
                    <input type="text" id="designName" placeholder="Enter a name for this design">
                </div>
                <div>
                    <label for="designType">Design Type:</label>
                    <select id="designType">
                        <option value="circle">Transmutation Circle</option>
                        <option value="polygon">Alchemical Polygon</option>
                        <option value="ingredient">Ingredient Composition</option>
                    </select>
                </div>
                <div>
                    <label for="designNotes">Research Notes:</label>
                    <textarea id="designNotes" placeholder="Record your observations and theories about this design"></textarea>
                </div>
                <div class="save-actions">
                    <button class="control-btn danger" onclick="closeSaveDialog()">Cancel</button>
                    <button class="control-btn success" onclick="confirmSaveDesign()">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tooltip element -->
    <div class="tooltip" id="tooltip"></div>
    
    <script>
             // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                // Random position
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                
                // Random size
                const size = Math.random() * 3 + 1;
                
                // Random animation duration and delay
                const duration = Math.random() * 15 + 5;
                const delay = Math.random() * 10;
                
                particle.style.left = `${posX}%`;
                particle.style.top = `${posY}%`;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.animationDuration = `${duration}s`;
                particle.style.animationDelay = `${delay}s`;
                
                particlesContainer.appendChild(particle);
            }
        }
        
        // Toggle ingredient category visibility
        function toggleCategory(category) {
            category.classList.toggle('active');
            const arrow = category.querySelector('.category-header span:last-child');
            arrow.textContent = category.classList.contains('active') ? '▼' : '▶';
        }
        
        // Initialize workbench grid
        function initWorkbenchGrid() {
            const grid = document.getElementById('workbenchGrid');
            grid.innerHTML = '';
            
            // Create 10x10 grid
            for (let row = 0; row < 10; row++) {
                for (let col = 0; col < 10; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    grid.appendChild(cell);
                }
            }
            
            // Add back the circle overlay
            const overlay = document.createElement('div');
            overlay.classList.add('transmutation-circle-overlay');
            grid.appendChild(overlay);
            
            // Set up drag and drop
            setupDragAndDrop();
        }
        
        // Set up drag and drop functionality
        function setupDragAndDrop() {
            const ingredients = document.querySelectorAll('.ingredient-item');
            const gridCells = document.querySelectorAll('.grid-cell');
            
            // Drag start for ingredients
            ingredients.forEach(ingredient => {
                ingredient.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        name: this.dataset.name,
                        symbol: this.dataset.symbol,
                        type: this.dataset.type,
                        properties: this.dataset.properties
                    }));
                });
            });
            
            // Drag over for grid cells
            gridCells.forEach(cell => {
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = 'rgba(255, 215, 0, 0.1)';
                });
                
                cell.addEventListener('dragleave', function() {
                    this.style.backgroundColor = '';
                });
                
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '';
                    
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    placeIngredient(data, this);
                });
            });
        }
        
        // Place an ingredient on the workbench
        function placeIngredient(data, cell) {
            // Check if cell already has an ingredient
            if (cell.querySelector('.placed-ingredient')) {
                return;
            }
            
            const ingredient = document.createElement('div');
            ingredient.classList.add('placed-ingredient');
            ingredient.dataset.name = data.name;
            ingredient.dataset.symbol = data.symbol;
            ingredient.dataset.type = data.type;
            ingredient.dataset.properties = data.properties;
            
            // Position at random offset within cell for organic look
            const offsetX = Math.random() * 20 - 10;
            const offsetY = Math.random() * 20 - 10;
            
            ingredient.style.left = `calc(${(cell.dataset.col * 10)}% + ${offsetX}px)`;
            ingredient.style.top = `calc(${(cell.dataset.row * 10)}% + ${offsetY}px)`;
            
            ingredient.innerHTML = `
                <div class="placed-icon">${data.symbol}</div>
                <div class="placed-name">${data.name}</div>
            `;
            
            // Make draggable within workbench
            ingredient.draggable = true;
            ingredient.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', JSON.stringify({
                    name: this.dataset.name,
                    symbol: this.dataset.symbol,
                    type: this.dataset.type,
                    properties: this.dataset.properties
                }));
                // Mark for removal
                this.classList.add('dragging');
            });
            
            // Remove original when dropped elsewhere
            ingredient.addEventListener('dragend', function() {
                if (this.classList.contains('dragging')) {
                    this.remove();
                }
            });
            
            // Add tooltip
            setupIngredientTooltip(ingredient);
            
            document.getElementById('workbenchGrid').appendChild(ingredient);
        }
        
        // Set up tooltips for placed ingredients
        function setupIngredientTooltip(ingredient) {
            const tooltip = document.getElementById('tooltip');
            
            ingredient.addEventListener('mouseenter', function(e) {
                tooltip.textContent = `${this.dataset.name} (${this.dataset.type})\nProperties: ${this.dataset.properties}`;
                tooltip.classList.add('show');
                
                // Position tooltip near the cursor
                const x = e.clientX + 10;
                const y = e.clientY + 10;
                
                tooltip.style.left = `${x}px`;
                tooltip.style.top = `${y}px`;
            });
            
            ingredient.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
            
            ingredient.addEventListener('mousemove', function(e) {
                const x = e.clientX + 10;
                const y = e.clientY + 10;
                
                tooltip.style.left = `${x}px`;
                tooltip.style.top = `${y}px`;
            });
        }
        
        // Show transmutation circle overlay
        function showTransmutationCircle() {
            document.getElementById('workbench').classList.add('show-circle');
        }
        
        // Hide transmutation circle overlay
        function hideTransmutationCircle() {
            document.getElementById('workbench').classList.remove('show-circle');
        }
        
        // Clear the workbench
        function clearWorkbench() {
            const placedIngredients = document.querySelectorAll('.placed-ingredient');
            placedIngredients.forEach(ing => ing.remove());
            
            addResultMessage('Workbench cleared.', 'warning');
        }
        
        // Attempt a transmutation
        function attemptTransmutation() {
            const ingredients = document.querySelectorAll('.placed-ingredient');
            
            if (ingredients.length === 0) {
                addResultMessage('No ingredients placed on workbench.', 'failure');
                return;
            }
            
            // Analyze ingredients
            const ingredientTypes = {};
            let metalCount = 0;
            let mineralCount = 0;
            let herbCount = 0;
            let essenceCount = 0;
            
            ingredients.forEach(ing => {
                const type = ing.dataset.type;
                ingredientTypes[type] = (ingredientTypes[type] || 0) + 1;
                
                switch(type) {
                    case 'metal': metalCount++; break;
                    case 'mineral': mineralCount++; break;
                    case 'herb': herbCount++; break;
                    case 'essence': essenceCount++; break;
                }
            });
            
            // Determine possible transmutation
            let result = '';
            let success = false;
            
            // Metal + Essence = Alloy
            if (metalCount >= 1 && essenceCount >= 1) {
                const metals = Array.from(ingredients).filter(i => i.dataset.type === 'metal');
                const essences = Array.from(ingredients).filter(i => i.dataset.type === 'essence');
                
                result = `Created ${getRandomAlloyName(metals[0].dataset.name)} alloy`;
                success = true;
            }
            // Herb + Mineral = Elixir
            else if (herbCount >= 1 && mineralCount >= 1) {
                const herbs = Array.from(ingredients).filter(i => i.dataset.type === 'herb');
                const minerals = Array.from(ingredients).filter(i => i.dataset.type === 'mineral');
                
                result = `Brewed ${getRandomElixirName(herbs[0].dataset.name)} elixir`;
                success = true;
            }
            // Multiple metals = Composite metal
            else if (metalCount >= 2) {
                const metals = Array.from(ingredients).filter(i => i.dataset.type === 'metal');
                result = `Forged ${metals[0].dataset.name}-${metals[1].dataset.name} composite`;
                success = true;
            }
            // Other combinations
            else {
                result = 'Transmutation failed. No viable reaction detected.';
            }
            
            // Add result message
            addResultMessage(result, success ? 'success' : 'failure');
            
            // Clear workbench on success
            if (success) {
                setTimeout(clearWorkbench, 1000);
            }
        }
        
        // Generate random alloy name
        function getRandomAlloyName(baseMetal) {
            const prefixes = ['Mystic', 'Alchemical', 'Arcane', 'Enchanted', 'Celestial'];
            const suffixes = ['Steel', 'Alloy', 'Amalgam', 'Composite', 'Mixture'];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${baseMetal} ${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
        }
        
        // Generate random elixir name
        function getRandomElixirName(baseHerb) {
            const prefixes = ['Potion of', 'Elixir of', 'Tincture of', 'Essence of', 'Extract of'];
            const effects = ['Vitality', 'Clarity', 'Strength', 'Wisdom', 'Fortitude'];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${baseHerb} ${effects[Math.floor(Math.random() * effects.length)]}`;
        }
        
        // Add result message
        function addResultMessage(message, type) {
            const results = document.getElementById('resultsContent');
            const resultItem = document.createElement('div');
            resultItem.classList.add('result-item', `result-${type}`);
            
            let icon = '⚗️';
            if (type === 'success') icon = '✅';
            if (type === 'failure') icon = '❌';
            if (type === 'warning') icon = '⚠️';
            
            resultItem.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div class="result-text">${message}</div>
            `;
            
            results.insertBefore(resultItem, results.firstChild);
            
            // Limit to 10 messages
            if (results.children.length > 10) {
                results.removeChild(results.lastChild);
            }
        }
        
        // Initialize on page load
        window.onload = function() {
            createParticles();
            initWorkbenchGrid();
            
            // Auto-open first category
            document.querySelector('.category').classList.add('active');
        };




        // Global variables
        let currentMode = 'ingredients';
        let currentDesign = null;
        let selectedCircle = null;
        let selectedPolygon = null;
        let researchNotes = JSON.parse(localStorage.getItem('alchemyResearchNotes')) || [];
        
        // Initialize the application
        window.onload = function() {
            createParticles();
            initWorkbenchGrid();
            setupEventListeners();
            loadResearchNotes();
            
            // Auto-open first category
            document.querySelector('.category').classList.add('active');
        };
        
        // Set up event listeners
        function setupEventListeners() {
            // Workbench mode buttons
            document.querySelectorAll('.workbench-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    setWorkbenchMode(this.dataset.mode);
                });
            });
            
            // Circle size slider
            document.getElementById('circleSizeSlider').addEventListener('input', function() {
                document.getElementById('circleSizeValue').textContent = `${this.value}px`;
                if (selectedCircle) {
                    updateCircleSize(selectedCircle, this.value);
                }
            });
            
            // Polygon size slider
            document.getElementById('polygonSizeSlider').addEventListener('input', function() {
                document.getElementById('polygonSizeValue').textContent = `${this.value}px`;
                if (selectedPolygon) {
                    updatePolygonSize(selectedPolygon, this.value);
                }
            });
            
            // Research notes button
            document.getElementById('researchNotesBtn').addEventListener('click', function(e) {
                e.preventDefault();
                toggleResearchNotes();
            });
            
            // Setup symbol click events for circles and polygons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('symbol')) {
                    e.target.classList.toggle('glowing');
                }
                
                if (e.target.classList.contains('circle-layer')) {
                    selectCircle(e.target);
                }
                
                if (e.target.classList.contains('polygon-shape')) {
                    selectPolygon(e.target);
                }
            });
        }
        
        // Set workbench mode
        function setWorkbenchMode(mode) {
            currentMode = mode;
            
            // Update active button
            document.querySelectorAll('.workbench-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // Show/hide controls
            document.getElementById('circleControls').style.display = 
                (mode === 'circle') ? 'block' : 'none';
            document.getElementById('polygonControls').style.display = 
                (mode === 'polygon') ? 'block' : 'none';
            
            // Clear selection
            if (mode !== 'circle') selectedCircle = null;
            if (mode !== 'polygon') selectedPolygon = null;
        }
        
        // Initialize workbench grid
        function initWorkbenchGrid() {
            const grid = document.getElementById('workbenchGrid');
            grid.innerHTML = '';
            
            // Create 10x10 grid
            for (let row = 0; row < 10; row++) {
                for (let col = 0; col < 10; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    grid.appendChild(cell);
                }
            }
            
            // Set up drag and drop for ingredients mode
            setupDragAndDrop();
        }
        
        // Set up drag and drop functionality
        function setupDragAndDrop() {
            const ingredients = document.querySelectorAll('.ingredient-item');
            const gridCells = document.querySelectorAll('.grid-cell');
            
            // Drag start for ingredients
            ingredients.forEach(ingredient => {
                ingredient.addEventListener('dragstart', function(e) {
                    if (currentMode !== 'ingredients') {
                        e.preventDefault();
                        return;
                    }
                    
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        name: this.dataset.name,
                        symbol: this.dataset.symbol,
                        type: this.dataset.type,
                        properties: this.dataset.properties
                    }));
                });
            });
            
            // Drag over for grid cells
            gridCells.forEach(cell => {
                cell.addEventListener('dragover', function(e) {
                    if (currentMode !== 'ingredients') {
                        e.preventDefault();
                        return;
                    }
                    
                    e.preventDefault();
                    this.style.backgroundColor = 'rgba(255, 215, 0, 0.1)';
                });
                
                cell.addEventListener('dragleave', function() {
                    this.style.backgroundColor = '';
                });
                
                cell.addEventListener('drop', function(e) {
                    if (currentMode !== 'ingredients') {
                        e.preventDefault();
                        return;
                    }
                    
                    e.preventDefault();
                    this.style.backgroundColor = '';
                    
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    placeIngredient(data, this);
                });
            });
        }
        
        /* Place an ingredient on the workbench */
        function placeIngredient(data, cell) {
            // Check if cell already has an ingredient
            if (cell.querySelector('.placed-ingredient')) {
                return;
            }
            
            const ingredient = document.createElement('div');
            ingredient.classList.add('placed-ingredient');
            ingredient.dataset.name = data.name;
            ingredient.dataset.symbol = data.symbol;
            ingredient.dataset.type = data.type;
            ingredient.dataset.properties = data.properties;
            
            // Position at random offset within cell for organic look
            const offsetX = Math.random() * 20 - 10;
            const offsetY = Math.random() * 20 - 10;
            
            ingredient.style.left = `calc(${(cell.dataset.col * 10)}% + ${offsetX}px)`;
            ingredient.style.top = `calc(${(cell.dataset.row * 10)}% + ${offsetY}px)`;
            
            ingredient.innerHTML = `
                <div class="placed-icon">${data.symbol}</div>
                <div class="placed-name">${data.name}</div>
            `;
            
            // Make draggable within workbench
            ingredient.draggable = true;
            ingredient.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', JSON.stringify({
                    name: this.dataset.name,
                    symbol: this.dataset.symbol,
                    type: this.dataset.type,
                    properties: this.dataset.properties
                }));
                // Mark for removal
                this.classList.add('dragging');
            });
            
            // Remove original when dropped elsewhere
            ingredient.addEventListener('dragend', function() {
                if (this.classList.contains('dragging')) {
                    this.remove();
                }
            });
            
            // Add tooltip
            setupIngredientTooltip(ingredient);
            
            document.getElementById('workbenchGrid').appendChild(ingredient);
        }
        
        /* Circle Design Functions */
        function generateCircle() {
            const size = document.getElementById('circleSizeSlider').value;
            const symbolCount = document.getElementById('symbolCountInput').value;
            
            const circle = document.createElement('div');
            circle.classList.add('circle-layer');
            circle.style.width = `${size}px`;
            circle.style.height = `${size}px`;
            
            // Position at center of workbench
            circle.style.left = '50%';
            circle.style.top = '50%';
            
            // Add symbols
            for (let i = 0; i < symbolCount; i++) {
                const angle = (i * (360 / symbolCount)) * (Math.PI / 180);
                const radius = size / 2;
                const x = 50 + Math.cos(angle) * radius * 0.8;
                const y = 50 + Math.sin(angle) * radius * 0.8;
                
                const symbol = document.createElement('div');
                symbol.classList.add('symbol');
                symbol.textContent = getRandomSymbol();
                symbol.style.left = `${x}%`;
                symbol.style.top = `${y}%`;
                
                circle.appendChild(symbol);
            }
            
            document.getElementById('workbenchGrid').appendChild(circle);
            selectCircle(circle);
        }
        
        function addNewCircle() {
            generateCircle();
        }
        
        function selectCircle(circle) {
            // Deselect previous
            if (selectedCircle) {
                selectedCircle.style.borderColor = '#ffd700';
            }
            
            selectedCircle = circle;
            circle.style.borderColor = '#00bfff';
            
            // Update controls to match selected circle
            document.getElementById('circleSizeSlider').value = parseInt(circle.style.width);
            document.getElementById('circleSizeValue').textContent = circle.style.width;
            
            const isRotating = circle.classList.contains('rotating');
            document.getElementById('rotationToggle').textContent = 
                isRotating ? 'Disable Rotation' : 'Enable Rotation';
                
            const isGlowing = circle.classList.contains('glowing');
            document.getElementById('glowToggle').textContent = 
                isGlowing ? 'Disable Glow' : 'Enable Glow';
        }
        
        function removeSelectedCircle() {
            if (selectedCircle) {
                selectedCircle.remove();
                selectedCircle = null;
            }
        }
        
        function toggleCircleRotation() {
            if (selectedCircle) {
                selectedCircle.classList.toggle('rotating');
                document.getElementById('rotationToggle').textContent = 
                    selectedCircle.classList.contains('rotating') ? 'Disable Rotation' : 'Enable Rotation';
            }
        }
        
        function toggleCircleGlow() {
            if (selectedCircle) {
                selectedCircle.classList.toggle('glowing');
                document.getElementById('glowToggle').textContent = 
                    selectedCircle.classList.contains('glowing') ? 'Disable Glow' : 'Enable Glow';
            }
        }
        
        function updateCircleSize(circle, size) {
            circle.style.width = `${size}px`;
            circle.style.height = `${size}px`;
            
            // Update symbol positions
            const symbols = circle.querySelectorAll('.symbol');
            const symbolCount = symbols.length;
            
            symbols.forEach((symbol, i) => {
                const angle = (i * (360 / symbolCount)) * (Math.PI / 180);
                const radius = size / 2;
                const x = 50 + Math.cos(angle) * radius * 0.8;
                const y = 50 + Math.sin(angle) * radius * 0.8;
                
                symbol.style.left = `${x}%`;
                symbol.style.top = `${y}%`;
            });
        }
        
        /* Polygon Design Functions */
        function generatePolygon() {
            const size = document.getElementById('polygonSizeSlider').value;
            const sides = document.getElementById('polygonShapeSelect').value;
            const symbolCount = document.getElementById('polygonSymbolCountInput').value;
            
            const polygon = document.createElement('div');
            polygon.classList.add('polygon-shape');
            polygon.style.width = `${size}px`;
            polygon.style.height = `${size}px`;
            
            // Set polygon shape
            const radius = size / 2;
            const points = [];
            for (let i = 0; i < sides; i++) {
                const angle = (i * (360 / sides) - 90) * (Math.PI / 180);
                const x = 50 + Math.cos(angle) * radius;
                const y = 50 + Math.sin(angle) * radius;
                points.push(`${x}% ${y}%`);
            }
            
            polygon.style.clipPath = `polygon(${points.join(', ')})`;
            
            // Position at center of workbench
            polygon.style.left = '50%';
            polygon.style.top = '50%';
            
            // Add symbols
            for (let i = 0; i < symbolCount; i++) {
                const angle = (i * (360 / symbolCount)) * (Math.PI / 180);
                const symbolRadius = radius * 0.7;
                const x = 50 + Math.cos(angle) * symbolRadius;
                const y = 50 + Math.sin(angle) * symbolRadius;
                
                const symbol = document.createElement('div');
                symbol.classList.add('symbol');
                symbol.textContent = getRandomSymbol();
                symbol.style.left = `${x}%`;
                symbol.style.top = `${y}%`;
                
                polygon.appendChild(symbol);
            }
            
            document.getElementById('workbenchGrid').appendChild(polygon);
            selectPolygon(polygon);
        }
        
        function addNewPolygon() {
            generatePolygon();
        }
        
        function selectPolygon(polygon) {
            // Deselect previous
            if (selectedPolygon) {
                selectedPolygon.style.borderColor = '#00bfff';
            }
            
            selectedPolygon = polygon;
            polygon.style.borderColor = '#ffd700';
            
            // Update controls to match selected polygon
            document.getElementById('polygonSizeSlider').value = parseInt(polygon.style.width);
            document.getElementById('polygonSizeValue').textContent = polygon.style.width;
            
            const isRotating = polygon.classList.contains('rotating');
            document.getElementById('polygonRotationToggle').textContent = 
                isRotating ? 'Disable Rotation' : 'Enable Rotation';
                
            const isGlowing = polygon.classList.contains('glowing');
            document.getElementById('polygonGlowToggle').textContent = 
                isGlowing ? 'Disable Glow' : 'Enable Glow';
        }
        
        function removeSelectedPolygon() {
            if (selectedPolygon) {
                selectedPolygon.remove();
                selectedPolygon = null;
            }
        }
        
        function togglePolygonRotation() {
            if (selectedPolygon) {
                selectedPolygon.classList.toggle('rotating');
                document.getElementById('polygonRotationToggle').textContent = 
                    selectedPolygon.classList.contains('rotating') ? 'Disable Rotation' : 'Enable Rotation';
            }
        }
        
        function togglePolygonGlow() {
            if (selectedPolygon) {
                selectedPolygon.classList.toggle('glowing');
                document.getElementById('polygonGlowToggle').textContent = 
                    selectedPolygon.classList.contains('glowing') ? 'Disable Glow' : 'Enable Glow';
            }
        }
        
        function updatePolygonSize(polygon, size) {
            polygon.style.width = `${size}px`;
            polygon.style.height = `${size}px`;
            
            // Update polygon shape
            const sides = document.getElementById('polygonShapeSelect').value;
            const radius = size / 2;
            const points = [];
            for (let i = 0; i < sides; i++) {
                const angle = (i * (360 / sides) - 90) * (Math.PI / 180);
                const x = 50 + Math.cos(angle) * radius;
                const y = 50 + Math.sin(angle) * radius;
                points.push(`${x}% ${y}%`);
            }
            
            polygon.style.clipPath = `polygon(${points.join(', ')})`;
            
            // Update symbol positions
            const symbols = polygon.querySelectorAll('.symbol');
            const symbolCount = symbols.length;
            
            symbols.forEach((symbol, i) => {
                const angle = (i * (360 / symbolCount)) * (Math.PI / 180);
                const symbolRadius = radius * 0.7;
                const x = 50 + Math.cos(angle) * symbolRadius;
                const y = 50 + Math.sin(angle) * symbolRadius;
                
                symbol.style.left = `${x}%`;
                symbol.style.top = `${y}%`;
            });
        }
        
        /* Save Design Functions */
        function saveCircleDesign() {
            if (!selectedCircle) {
                addResultMessage('No circle selected to save.', 'failure');
                return;
            }
            
            currentDesign = {
                type: 'circle',
                element: selectedCircle,
                symbols: Array.from(selectedCircle.querySelectorAll('.symbol')).map(symbol => ({
                    text: symbol.textContent,
                    position: {
                        left: symbol.style.left,
                        top: symbol.style.top
                    },
                    glowing: symbol.classList.contains('glowing')
                })),
                size: selectedCircle.style.width,
                rotating: selectedCircle.classList.contains('rotating'),
                glowing: selectedCircle.classList.contains('glowing')
            };
            
            openSaveDialog();
        }
        
        function savePolygonDesign() {
            if (!selectedPolygon) {
                addResultMessage('No polygon selected to save.', 'failure');
                return;
            }
            
            currentDesign = {
                type: 'polygon',
                element: selectedPolygon,
                symbols: Array.from(selectedPolygon.querySelectorAll('.symbol')).map(symbol => ({
                    text: symbol.textContent,
                    position: {
                        left: symbol.style.left,
                        top: symbol.style.top
                    },
                    glowing: symbol.classList.contains('glowing')
                })),
                size: selectedPolygon.style.width,
                sides: document.getElementById('polygonShapeSelect').value,
                rotating: selectedPolygon.classList.contains('rotating'),
                glowing: selectedPolygon.classList.contains('glowing')
            };
            
            openSaveDialog();
        }
        
        function openSaveDialog() {
            document.getElementById('saveDialog').style.display = 'block';
            document.getElementById('designType').value = currentDesign.type;
        }
        
        function closeSaveDialog() {
            document.getElementById('saveDialog').style.display = 'none';
            currentDesign = null;
        }
        
        function confirmSaveDesign() {
            const name = document.getElementById('designName').value.trim();
            const notes = document.getElementById('designNotes').value.trim();
            
            if (!name) {
                alert('Please enter a name for your design.');
                return;
            }
            
            const designData = {
                id: Date.now(),
                name: name,
                type: currentDesign.type,
                date: new Date().toLocaleDateString(),
                notes: notes,
                properties: {
                    size: currentDesign.size,
                    rotating: currentDesign.rotating,
                    glowing: currentDesign.glowing,
                    symbols: currentDesign.symbols
                },
                results: getRecentResults()
            };
            
            if (currentDesign.type === 'polygon') {
                designData.properties.sides = currentDesign.sides;
            }
            
            // Save to research notes
            researchNotes.unshift(designData);
            saveResearchNotes();
            
            // Update UI
            addResearchNoteCard(designData);
            addResultMessage(`Design "${name}" saved to research notes.`, 'success');
            
            // Reset dialog
            document.getElementById('designName').value = '';
            document.getElementById('designNotes').value = '';
            closeSaveDialog();
        }
        
        /* Research Notes Functions */
        function toggleResearchNotes() {
            const labInterface = document.getElementById('labInterface');
            const researchNotes = document.getElementById('researchNotes');
            
            if (researchNotes.style.display === 'block') {
                researchNotes.style.display = 'none';
                labInterface.style.display = 'block';
            } else {
                researchNotes.style.display = 'block';
                labInterface.style.display = 'none';
            }
        }
        
        function loadResearchNotes() {
            researchNotes.forEach(note => {
                addResearchNoteCard(note);
            });
        }
        
        function addResearchNoteCard(note) {
            const notesGrid = document.getElementById('notesGrid');
            
            const card = document.createElement('div');
            card.classList.add('note-card');
            card.dataset.id = note.id;
            
            card.innerHTML = `
                <div class="note-card-inner">
                    <div class="note-card-front">
                        <div class="note-title">${note.name}</div>
                        <div class="note-date">${note.date}</div>
                        <div class="note-circle-preview">
                            <div class="note-circle" id="preview-${note.id}"></div>
                        </div>
                        <div class="note-content">${note.notes || 'No additional notes.'}</div>
                    </div>
                    <div class="note-card-back">
                        <div class="note-title">Transmutation Results</div>
                        <div class="note-results">${formatResultsForNote(note.results)}</div>
                    </div>
                </div>
            `;
            
            // Add click event to flip card
            card.addEventListener('click', function() {
                this.classList.toggle('flipped');
            });
            
            notesGrid.insertBefore(card, notesGrid.firstChild);
            
            // Render the preview
            renderDesignPreview(note, document.getElementById(`preview-${note.id}`));
        }
        
        function renderDesignPreview(note, container) {
            container.innerHTML = '';
            
            if (note.type === 'circle') {
                const preview = document.createElement('div');
                preview.classList.add('circle-layer');
                if (note.properties.glowing) preview.classList.add('glowing');
                if (note.properties.rotating) preview.classList.add('rotating');
                
                preview.style.width = `calc(${note.properties.size} * 0.5)`;
                preview.style.height = `calc(${note.properties.size} * 0.5)`;
                
                note.properties.symbols.forEach(symbol => {
                    const symbolElement = document.createElement('div');
                    symbolElement.classList.add('symbol');
                    if (symbol.glowing) symbolElement.classList.add('glowing');
                    symbolElement.textContent = symbol.text;
                    symbolElement.style.left = symbol.position.left;
                    symbolElement.style.top = symbol.position.top;
                    
                    preview.appendChild(symbolElement);
                });
                
                container.appendChild(preview);
            } else if (note.type === 'polygon') {
                const preview = document.createElement('div');
                preview.classList.add('polygon-shape');
                if (note.properties.glowing) preview.classList.add('glowing');
                if (note.properties.rotating) preview.classList.add('rotating');
                
                preview.style.width = `calc(${note.properties.size} * 0.5)`;
                preview.style.height = `calc(${note.properties.size} * 0.5)`;
                
                // Set polygon shape
                const size = parseInt(note.properties.size) * 0.5;
                const radius = size / 2;
                const points = [];
                for (let i = 0; i < note.properties.sides; i++) {
                    const angle = (i * (360 / note.properties.sides) - 90) * (Math.PI / 180);
                    const x = 50 + Math.cos(angle) * radius;
                    const y = 50 + Math.sin(angle) * radius;
                    points.push(`${x}% ${y}%`);
                }
                
                preview.style.clipPath = `polygon(${points.join(', ')})`;
                
                note.properties.symbols.forEach(symbol => {
                    const symbolElement = document.createElement('div');
                    symbolElement.classList.add('symbol');
                    if (symbol.glowing) symbolElement.classList.add('glowing');
                    symbolElement.textContent = symbol.text;
                    symbolElement.style.left = symbol.position.left;
                    symbolElement.style.top = symbol.position.top;
                    
                    preview.appendChild(symbolElement);
                });
                
                container.appendChild(preview);
            }
        }
        
        function saveResearchNotes() {
            localStorage.setItem('alchemyResearchNotes', JSON.stringify(researchNotes));
        }
        
        /* Transmutation Functions */
        function attemptTransmutation() {
            if (currentMode === 'circle' && selectedCircle) {
                const result = analyzeCircleTransmutation(selectedCircle);
                addResultMessage(result.message, result.success ? 'success' : 'failure');
                
                if (result.success) {
                    selectedCircle.classList.add('transmutation-effect');
                    setTimeout(() => {
                        selectedCircle.classList.remove('transmutation-effect');
                    }, 3000);
                }
            } 
            else if (currentMode === 'polygon' && selectedPolygon) {
                const result = analyzePolygonTransmutation(selectedPolygon);
                addResultMessage(result.message, result.success ? 'success' : 'failure');
                
                if (result.success) {
                    selectedPolygon.classList.add('transmutation-effect');
                    setTimeout(() => {
                        selectedPolygon.classList.remove('transmutation-effect');
                    }, 3000);
                }
            }
            else if (currentMode === 'ingredients') {
                const ingredients = document.querySelectorAll('.placed-ingredient');
                
                if (ingredients.length === 0) {
                    addResultMessage('No ingredients placed on workbench.', 'failure');
                    return;
                }
                
                const result = analyzeIngredientTransmutation(ingredients);
                addResultMessage(result.message, result.success ? 'success' : 'failure');
                
                if (result.success) {
                    // Clear workbench on success
                    setTimeout(clearWorkbench, 1000);
                }
            } else {
                addResultMessage('No active design or ingredients for transmutation.', 'failure');
            }
        }
        
        function analyzeCircleTransmutation(circle) {
            const symbols = circle.querySelectorAll('.symbol');
            const glowingSymbols = circle.querySelectorAll('.symbol.glowing');
            
            // More sophisticated analysis
            const symbolTexts = Array.from(symbols).map(s => s.textContent);
            const uniqueSymbols = [...new Set(symbolTexts)];
            
            // Determine circle properties
            const size = parseInt(circle.style.width);
            const isRotating = circle.classList.contains('rotating');
            const isGlowing = circle.classList.contains('glowing');
            
            // Evaluate transmutation potential
            let success = false;
            let message = '';
            
            if (symbols.length >= 6 && glowingSymbols.length >= 3) {
                const powerLevel = glowingSymbols.length * (isRotating ? 1.5 : 1) * (isGlowing ? 1.5 : 1);
                
                if (powerLevel > 10) {
                    success = true;
                    const results = [
                        "Created Philosopher's Stone fragment",
                        "Opened portal to the Gate of Truth",
                        "Achieved perfect gold transmutation",
                        "Discovered new alchemical principle",
                        "Synthesized homunculus core"
                    ];
                    message = `Powerful transmutation successful! ${results[Math.floor(Math.random() * results.length)]}`;
                } else {
                    message = `Partial transmutation achieved. Power level: ${powerLevel.toFixed(1)}/10`;
                }
            } else {
                message = "Insufficient symbols or energy for transmutation. Add more symbols and activate them.";
            }
            
            return { success, message };
        }
        
        function analyzePolygonTransmutation(polygon) {
            const symbols = polygon.querySelectorAll('.symbol');
            const glowingSymbols = polygon.querySelectorAll('.symbol.glowing');
            const sides = document.getElementById('polygonShapeSelect').value;
            
            // More sophisticated analysis
            const symbolTexts = Array.from(symbols).map(s => s.textContent);
            const uniqueSymbols = [...new Set(symbolTexts)];
            
            // Determine polygon properties
            const size = parseInt(polygon.style.width);
            const isRotating = polygon.classList.contains('rotating');
            const isGlowing = polygon.classList.contains('glowing');
            
            // Evaluate transmutation potential
            let success = false;
            let message = '';
            
            if (symbols.length >= sides && glowingSymbols.length >= Math.floor(sides/2)) {
                const powerLevel = glowingSymbols.length * (isRotating ? 1.2 : 1) * (isGlowing ? 1.2 : 1) * (sides/4);
                
                if (powerLevel > 8) {
                    success = true;
                    const results = [
                        "Created elemental binding matrix",
                        "Established alchemical containment field",
                        "Synthesized polymorphic material",
                        "Discovered new geometric principle",
                        "Achieved perfect structural transmutation"
                    ];
                    message = `Complex transmutation successful! ${results[Math.floor(Math.random() * results.length)]}`;
                } else {
                    message = `Partial geometric transmutation achieved. Power level: ${powerLevel.toFixed(1)}/10`;
                }
            } else {
                message = "Insufficient symbols or improper geometry for transmutation. Adjust your design.";
            }
            
            return { success, message };
        }
        
        function analyzeIngredientTransmutation(ingredients) {
            // More sophisticated ingredient analysis
            const ingredientTypes = {};
            let metalCount = 0;
            let mineralCount = 0;
            let herbCount = 0;
            let essenceCount = 0;
            
            Array.from(ingredients).forEach(ing => {
                const type = ing.dataset.type;
                ingredientTypes[type] = (ingredientTypes[type] || 0) + 1;
                
                switch(type) {
                    case 'metal': metalCount++; break;
                    case 'mineral': mineralCount++; break;
                    case 'herb': herbCount++; break;
                    case 'essence': essenceCount++; break;
                }
            });
            
            // Determine possible transmutation
            let result = '';
            let success = false;
            
            // Special combinations
            if (metalCount >= 3 && essenceCount >= 1) {
                const metals = Array.from(ingredients).filter(i => i.dataset.type === 'metal');
                const essences = Array.from(ingredients).filter(i => i.dataset.type === 'essence');
                
                result = `Created ${getAdvancedAlloyName(metals)} with ${essences[0].dataset.name} infusion`;
                success = true;
            }
            // Herb + Mineral + Essence = Potion
            else if (herbCount >= 1 && mineralCount >= 1 && essenceCount >= 1) {
                const herbs = Array.from(ingredients).filter(i => i.dataset.type === 'herb');
                const minerals = Array.from(ingredients).filter(i => i.dataset.type === 'mineral');
                const essences = Array.from(ingredients).filter(i => i.dataset.type === 'essence');
                
                result = `Brewed ${getAdvancedPotionName(herbs, minerals, essences)}`;
                success = true;
            }
            // Multiple metals = Composite metal
            else if (metalCount >= 2) {
                const metals = Array.from(ingredients).filter(i => i.dataset.type === 'metal');
                result = `Forged ${metals[0].dataset.name}-${metals[1].dataset.name} composite`;
                success = true;
            }
            // Mineral + Essence = Crystal
            else if (mineralCount >= 1 && essenceCount >= 1) {
                const minerals = Array.from(ingredients).filter(i => i.dataset.type === 'mineral');
                const essences = Array.from(ingredients).filter(i => i.dataset.type === 'essence');
                result = `Crystallized ${minerals[0].dataset.name} with ${essences[0].dataset.name} essence`;
                success = true;
            }
            // Other combinations
            else {
                const failureResults = [
                    "Transmutation failed. No viable reaction detected.",
                    "Equivalent exchange not balanced. Try different components.",
                    "Insufficient energy for transmutation. Add more powerful ingredients.",
                    "Unstable reaction occurred. Components were destroyed.",
                    "Mysterious forces prevented the transmutation."
                ];
                result = failureResults[Math.floor(Math.random() * failureResults.length)];
            }
            
            return { success, message: result };
        }
        
        /* Helper Functions */
        function getRandomSymbol() {
            const symbols = ['☉', '☽', '♂', '♀', '♃', '♄', '☿', '🜁', '🜂', '🜃', '🜄', '🜅'];
            return symbols[Math.floor(Math.random() * symbols.length)];
        }
        
        function getAdvancedAlloyName(metals) {
            const prefixes = ['Eldritch', 'Mystic', 'Arcane', 'Celestial', 'Forgotten'];
            const suffixes = ['Alloy', 'Amalgam', 'Composite', 'Fusion', 'Matrix'];
            const metalNames = metals.map(m => m.dataset.name);
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${metalNames.join('-')} ${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
        }
        
        function getAdvancedPotionName(herbs, minerals, essences) {
            const potionTypes = ['Elixir', 'Tincture', 'Potion', 'Essence', 'Extract'];
            const effects = ['Vitality', 'Transmutation', 'Revelation', 'Power', 'Transformation'];
            return `${potionTypes[Math.floor(Math.random() * potionTypes.length)]} of ${herbs[0].dataset.name} and ${minerals[0].dataset.name} (${essences[0].dataset.name} infused)`;
        }
        
        function addResultMessage(message, type) {
            const results = document.getElementById('resultsContent');
            const resultItem = document.createElement('div');
            resultItem.classList.add('result-item', `result-${type}`);
            
            let icon = '⚗️';
            if (type === 'success') icon = '✅';
            if (type === 'failure') icon = '❌';
            if (type === 'warning') icon = '⚠️';
            
            resultItem.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div class="result-text">${message}</div>
            `;
            
            results.insertBefore(resultItem, results.firstChild);
            
            // Limit to 10 messages
            if (results.children.length > 10) {
                results.removeChild(results.lastChild);
            }
        }
        
        function getRecentResults() {
            const results = document.getElementById('resultsContent');
            return Array.from(results.children).slice(0, 3).map(el => el.querySelector('.result-text').textContent);
        }
        
        function formatResultsForNote(results) {
            if (!results || results.length === 0) return 'No transmutation results recorded.';
            
            return results.map(r => `• ${r}`).join('<br>');
        }
        
        function clearWorkbench() {
            if (currentMode === 'ingredients') {
                const placedIngredients = document.querySelectorAll('.placed-ingredient');
                placedIngredients.forEach(ing => ing.remove());
            } 
            else if (currentMode === 'circle' && selectedCircle) {
                selectedCircle.remove();
                selectedCircle = null;
            }
            else if (currentMode === 'polygon' && selectedPolygon) {
                selectedPolygon.remove();
                selectedPolygon = null;
            }
            
            addResultMessage('Workbench cleared.', 'warning');
        }
        
        function toggleCategory(category) {
            category.classList.toggle('active');
            const arrow = category.querySelector('.category-header span:last-child');
            arrow.textContent = category.classList.contains('active') ? '▼' : '▶';
        }
        
        function setupIngredientTooltip(ingredient) {
            const tooltip = document.getElementById('tooltip');
            
            ingredient.addEventListener('mouseenter', function(e) {
                tooltip.textContent = `${this.dataset.name} (${this.dataset.type})\nProperties: ${this.dataset.properties}`;
                tooltip.classList.add('show');
                
                // Position tooltip near the cursor
                const x = e.clientX + 10;
                const y = e.clientY + 10;
                
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            });
            
            ingredient.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
            
            ingredient.addEventListener('mousemove', function(e) {
                const x = e.clientX + 10;
                const y = e.clientY + 10;
                
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            });
        }
        
        function showTransmutationCircle() {
            document.getElementById('workbench').classList.add('show-circle');
        }
        
        function hideTransmutationCircle() {
            document.getElementById('workbench').classList.remove('show-circle');
        }
    </script>
</body>
</html>